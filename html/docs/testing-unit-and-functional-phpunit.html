
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>[Part 6] - Testing: Unit and Functional with PHPUnit &mdash; symblog - A Symfony2 Tutorial</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="symblog - A Symfony2 Tutorial" href="../index.html" />
    <link rel="prev" title="[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic" href="customising-the-view-more-with-twig.html" />
<!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link href='http://fonts.googleapis.com/css?family=Irish+Grover' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=La+Belle+Aurore' rel='stylesheet' type='text/css'>
<style type="text/css">
    #header {line-height: 1;font-family: Arial, Helvetica, sans-serif;font-size: 12px; width: 100%; height: 100%; color: #000; font-size: 14px; }

    html { background: none; }
    a { text-decoration: none !important; color: #F48A00 !important; font-weight: normal !important }

    h1, h2, h3, h4, h5, h6 { color: #000 }

    #header a:link { font-weight: normal !important; }

    #header { border-bottom: 1px solid #ccc; margin-bottom: 20px; }
    #header .top { border-bottom: 1px solid #ccc; margin-bottom: 10px; }
    #header ul.languages { list-style: none; text-align: right; margin-bottom: 0; display: inline-block; }
    #header .languages li { display: inline }
    #header .languages li a { display: inline-block; padding: 10px 10px 10px 25px; border-right: 1px solid #ccc; background-repeat: no-repeat; background-position: 5px center  }
    #header .en { background-image: url('/_static/images/icons/languages/gb.png'); }
    #header .es { background-image: url('/_static/images/icons/languages/es.png'); }
    #header .fr { background-image: url('/_static/images/icons/languages/fr.png'); }
    #header ul.navigation { list-style: none; text-align: right; margin-bottom: 0; display: inline-block; float: right; }
    #header .navigation li { display: inline }
    #header .navigation li a { display: inline-block; padding: 10px 15px; border-left: 1px solid #ccc; }
    #header h2 { font-family: 'Irish Grover', cursive; font-size: 92px; text-align: center; line-height: 110px; border-bottom: none; margin: 0px; font-weight: normal; }
    #header h2 a { color: #000 !important }
    #header h3 { text-align: center; font-family: 'La Belle Aurore', cursive; font-size: 24px; margin: 0; margin-bottom: 20px; font-weight: normal;  font-weight: normal;}

    div.content { font-size: 0.9em; margin: 10px 20px 20px; }

    .note, .tip, .warning {
        border: 1px solid !important;
        margin: 10px 0px !important;
        padding:15px 10px 15px 70px !important;
        background-repeat: no-repeat !important;
        background-position: 10px center !important;
    }
    .note {
        border-color: #00529B !important;
        background-color: #DBF3FF !important;
        background-image: url('../_static/images/icons/note.png') !important;
    }
    .tip {
        border-color: #4F8A10 !important;
        background-color: #E5F2D0 !important;
        background-image:url('../_static/images/icons/tip.png') !important;
        }
    .warning {
        border-color: #9F6000 !important;
        background-color: #FFF7DB !important;
        background-image: url('../_static/images/icons/warning.png') !important;
    }
</style>

  </head>
  <body>

    <header id="header">
        <div class="top">
            <nav>
                <ul class="languages">
                    <li><a href="http://tutorial.symblog.co.uk" class="en">EN</a></li>
                    <li><a href="http://symblog.site90.net/" class="es">ES</a></li>
                    <li><a href="http://keiruaprod.fr/symblog-fr/" class="fr">FR</a></li>
                </ul>
                <ul class="navigation">
                    <li><a href="/">Home</a></li>
                    <li><a href="http://symblog.co.uk">Demo</a></li>
                    <li><a href="https://github.com/dsyph3r/symblog">Source</a></li>
                </ul>
            </nav>
        </div>

        <hgroup>
            <h2><a href="/">symblog</a></h2>
            <h3><a href="/">creating a blog in Symfony2</a></h3>
        </hgroup>
    </header>

  <div class="topnav">
  
        <p>
        «&#160;&#160;<a href="customising-the-view-more-with-twig.html">[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

  </div>
  <div class="content">

    
    
  <div class="section" id="part-6-testing-unit-and-functional-with-phpunit">
<h1>[Part 6] - Testing: Unit and Functional with PHPUnit<a class="headerlink" href="#part-6-testing-unit-and-functional-with-phpunit" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>So far we have explored a good amount of ground looking at a number of core
concepts with regards to Symfony2 development. Before we continue adding
features it is time to introduce testing. We will look at how to test individual
functions with unit testing and how to ensure multiple components are working
correctly together with functional testing. The PHP testing library <a class="reference external" href="http://www.phpunit.de/manual/current/en/">PHPUnit</a> will be covered as this library is
at the centre of the Symfony2 tests. As testing is a large topic it will also be
covered in later chapters. By the end of this chapter you will have written a
number of tests covering both unit and functional testing. You will have simulated
browser requests, populated forms with data, and checked responses to ensure
the website pages are outputting correctly. You will also have checked how much coverage
your tests have on your applications code base.</p>
</div>
<div class="section" id="testing-in-symfony2">
<h2>Testing in Symfony2<a class="headerlink" href="#testing-in-symfony2" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.phpunit.de/manual/current/en/">PHPUnit</a> has become the &#8220;de facto
standard&#8221; for writing tests in PHP, so learning it will benefit you in all your
PHP projects. Lets also not forget that most of the topics covered in this
chapter are language independent and so can be transferred to other languages
you.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you are planning on writing your own Open Source Symfony2 bundles,
you are much more likely to receive interest if your bundle is well
tested (and documented). Have a look at the existing Symfony2 bundles available
at <a class="reference external" href="http://symfony2bundles.org/">Symfony2Bundles</a>.</p>
</div>
<div class="section" id="unit-testing">
<h3>Unit Testing<a class="headerlink" href="#unit-testing" title="Permalink to this headline">¶</a></h3>
<p>Unit testing is concerned with ensuring individual units of code function
correctly when used in isolation. In an Object Oriented code base like Symfony2,
a unit would be a class and its methods. For example, we could write tests for
the <tt class="docutils literal"><span class="pre">Blog</span></tt> and <tt class="docutils literal"><span class="pre">Comment</span></tt> Entity classes. When writing unit tests, the test
cases should be written independently of other test cases, i.e., the result of test
case B should not depend on the result of test case A. It is useful when unit testing
to be able to create mock objects that allow you to easily unit test
functions that have external dependencies. Mocking allows you to simulate a function
call instead of actually executing it. An example of this
would be unit testing a class that wraps up an external API. The API class may
use a transport layer for communicating with the external API. We could mock the
request method of the transport layer to return the results we specify, rather
than actually hitting the external API. Unit testing does not test that the
components of an application function correctly together, this is covered by the
next topic, functional testing.</p>
</div>
<div class="section" id="functional-testing">
<h3>Functional Testing<a class="headerlink" href="#functional-testing" title="Permalink to this headline">¶</a></h3>
<p>Functional testing checks the integration of different components within the
application, such as routing, controllers, and views. Functional tests are
similar to the manual tests you would run yourself in the browser such as requesting
the homepage, clicking a blog link and checking the correct blog is shown.
Functional testing provides you with the ability to automate this process.
Symfony2 comes complete with a number of useful classes that assist in functional testing
including a <tt class="docutils literal"><span class="pre">Client</span></tt> that is able to requests pages and submit forms and DOM <tt class="docutils literal"><span class="pre">Crawler</span></tt>
that we can use to traverse the <tt class="docutils literal"><span class="pre">Response</span></tt> from the client.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">There are a number of software development process that are driven by testing.
These include processes such as Test Driven Development (TDD) and Behavioral
Driven Development (BDD). While these are out side the scope of this tutorial
you should be aware of the library written by <a class="reference external" href="https://twitter.com/#!/everzet">everzet</a> that facilitates BDD called <a class="reference external" href="http://behat.org/">Behat</a>. There is also a Symfony2 <a class="reference external" href="http://docs.behat.org/bundle/index.html">BehatBundle</a> available to easily integrate Behat
into your Symfony2 project.</p>
</div>
</div>
</div>
<div class="section" id="id2">
<h2>PHPUnit<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>As stated above, Symfony2 tests are written using PHPUnit. You will need to
install PHPUnit in order to run these tests and the tests from this chapter.
For detailed <a class="reference external" href="http://www.phpunit.de/manual/current/en/installation.html">installation instructions</a> refer to the
official documentation on the PHPUnit website. To run the tests in Symfony2 you
need to install PHPUnit 3.5.11 or later. PHPUnit is a very large testing library, so references
to the official documentation will be made where additional reading can be
found.</p>
<div class="section" id="assertions">
<h3>Assertions<a class="headerlink" href="#assertions" title="Permalink to this headline">¶</a></h3>
<p>Writing tests is concerened with checking that the actual test result is equal
to the expected test result. There are a number of assertion methods available
in PHPUnit to assist you with this task. Some of the common assertion
methods you will use are listed below.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// Check 1 === 1 is true</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="mi">1</span> <span class="o">===</span> <span class="mi">1</span><span class="p">);</span>

<span class="c1">// Check 1 === 2 is false</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertFalse</span><span class="p">(</span><span class="mi">1</span> <span class="o">===</span> <span class="mi">2</span><span class="p">);</span>

<span class="c1">// Check &#39;Hello&#39; equals &#39;Hello&#39;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="s1">&#39;Hello&#39;</span><span class="p">);</span>

<span class="c1">// Check array has key &#39;language&#39;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertArrayHasKey</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;language&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;php&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1024&#39;</span><span class="p">));</span>

<span class="c1">// Check array contains value &#39;php&#39;</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertContains</span><span class="p">(</span><span class="s1">&#39;php&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;php&#39;</span><span class="p">,</span> <span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;c++&#39;</span><span class="p">,</span> <span class="s1">&#39;JavaScript&#39;</span><span class="p">));</span>
</pre></div>
</div>
<p>A full list of
<a class="reference external" href="http://www.phpunit.de/manual/current/en/writing-tests-for-phpunit.html#writing-tests-for-phpunit.assertions">assertions</a>
is available in the PHPUnit documentation.</p>
</div>
</div>
<div class="section" id="running-symfony2-tests">
<h2>Running Symfony2 Tests<a class="headerlink" href="#running-symfony2-tests" title="Permalink to this headline">¶</a></h2>
<p>Before we begin writing some tests, lets look at how we run tests in Symfony2. PHPUnit
can be set to execute using a configuration file. In our Symfony2 project this
file is located at <tt class="docutils literal"><span class="pre">app/phpunit.xml.dist</span></tt>. As this file is suffixed with
<tt class="docutils literal"><span class="pre">.dist</span></tt>, you need to copy its contents into a file called <tt class="docutils literal"><span class="pre">app/phpunit.xml</span></tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you are using a VCS such as Git, you should add the new <tt class="docutils literal"><span class="pre">app/phpunit.xml</span></tt>
file to the VCS ignore list.</p>
</div>
<p>If you have a look at the contents of the PHPUnit configuration file you will see the
following.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/phpunit.xml --&gt;</span>

<span class="nt">&lt;testsuites&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">&quot;Project Test Suite&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;directory&gt;</span>../src/*/*Bundle/Tests<span class="nt">&lt;/directory&gt;</span>
        <span class="nt">&lt;directory&gt;</span>../src/*/Bundle/*Bundle/Tests<span class="nt">&lt;/directory&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
<span class="nt">&lt;/testsuites&gt;</span>
</pre></div>
</div>
<p>The following settings configure some directories that are part of our test suite.
When running PHPUnit it will look in the above directories for tests to run. You
can also pass additional command line arguments to PHPUnit to run tests in
specific directories, instead of the test suite tests. You will see how to
achieve this later.</p>
<p>You will also notice the configuration is specifying the bootstrap file located at
<tt class="docutils literal"><span class="pre">app/bootstrap.php.cache</span></tt>. This file is used by PHPUnit to get the testing environment
setup.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/phpunit.xml --&gt;</span>

<span class="nt">&lt;phpunit</span>
    <span class="na">bootstrap                   =</span> <span class="s">&quot;bootstrap.php.cache&quot;</span> <span class="nt">&gt;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">For more information regarding configuring PHPUnit with an XML file
see the
<a class="reference external" href="http://www.phpunit.de/manual/current/en/organizing-tests.html#organizing-tests.xml-configuration">PHPUnit documentation</a>.</p>
</div>
</div>
<div class="section" id="running-the-current-tests">
<h2>Running the Current Tests<a class="headerlink" href="#running-the-current-tests" title="Permalink to this headline">¶</a></h2>
<p>As we used one of the Symfony2 generator tasks to create the
<tt class="docutils literal"><span class="pre">BloggerBlogBundle</span></tt> back in chapter 1, it also created a controller test for
the <tt class="docutils literal"><span class="pre">DefaultController</span></tt> class. We can execute this test by running the
following command from the root directory of the project. The <tt class="docutils literal"><span class="pre">-c</span></tt> option
specifies that PHPUnit should load its configuration from the <tt class="docutils literal"><span class="pre">app</span></tt> directory.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app
</pre></div>
</div>
<p>Once the testing has completed you should be notified that the tests failed.
If you look at the <tt class="docutils literal"><span class="pre">DefaultControllerTest</span></tt> class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Controller/DefaultControllerTest.php</span></tt> you will see
the following content.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Tests/Controller/DefaultControllerTest.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Tests\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DefaultControllerTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testIndex</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">();</span>

        <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/hello/Fabien&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;html:contains(&quot;Hello Fabien&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a functional test for the <tt class="docutils literal"><span class="pre">DefaultController</span></tt> class that Symfony2 generated.
If you remember back to chapter 1, this Controller had an action that handled requests
to <tt class="docutils literal"><span class="pre">/hello/{name}</span></tt>. The fact that we removed this controller is why the above test
is failing. Try going to the URL <tt class="docutils literal"><span class="pre">http://symblog.dev/app_dev.php/hello/Fabien</span></tt> in
your browser. You should be informed that the route could not be found. As the
above test makes a request to the same URL, it will also get the same response,
hence why the test fails. Functional testing is a large part of this chapter and
will be covered in detail later.</p>
<p>As the <tt class="docutils literal"><span class="pre">DefaultController</span></tt> class has been removed, you can also remove this test
class. Delete the <tt class="docutils literal"><span class="pre">DefaultControllerTest</span></tt> class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Controller/DefaultControllerTest.php</span></tt>.</p>
</div>
<div class="section" id="id4">
<h2>Unit Testing<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>As explained previously, unit testing is concerned with testing individual units
of your application in isolation. When writing unit tests it is recommend that you
replicate the Bundle structure under the Tests folder. For example, if you wanted
to test the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Entity/Blog.php</span></tt> the test file would reside at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span></tt>. An example folder layout
would be as follows.</p>
<div class="highlight-text"><div class="highlight"><pre>src/Blogger/BlogBundle/
                Entity/
                    Blog.php
                    Comment.php
                Controller/
                    PageController.php
                Twig/
                    Extensions/
                        BloggerBlogExtension.php
                Tests/
                    Entity/
                        BlogTest.php
                        CommentTest.php
                    Controller/
                        PageControllerTest.php
                    Twig/
                        Extensions/
                            BloggerBlogExtensionTest.php
</pre></div>
</div>
<p>Notice that each of the Test files are suffixed with Test.</p>
<div class="section" id="testing-the-blog-entity-slugify-method">
<h3>Testing the Blog Entity - Slugify method<a class="headerlink" href="#testing-the-blog-entity-slugify-method" title="Permalink to this headline">¶</a></h3>
<p>We begin by testing the slugify method in the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity. Lets write some
tests to ensure this method is working correctly. Create a new file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span></tt> and add the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Tests\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Entity\Blog</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BlogTest</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
<p>We have created a test class for the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity. Notice the location of the file
complies with the folder structure mentioned above. The <tt class="docutils literal"><span class="pre">BlogTest</span></tt> class extends
the base PHPUnit class <tt class="docutils literal"><span class="pre">PHPUnit_Framework_TestCase</span></tt>. All tests you write for PHPUnit
will be a child of this class. You&#8217;ll remember from previous chapters that
the <tt class="docutils literal"><span class="pre">\</span></tt> must be placed in front of the <tt class="docutils literal"><span class="pre">PHPUnit_Framework_TestCase</span></tt> class
name as the class is declared in the PHP public namespace.</p>
<p>Now we have the skeleton class for our <tt class="docutils literal"><span class="pre">Blog</span></tt> entity tests, lets write a test
case. Test cases in PHPUnit are methods of the Test class prefixed
with <tt class="docutils literal"><span class="pre">test</span></tt>, such as <tt class="docutils literal"><span class="pre">testSlugify()</span></tt>. Update the <tt class="docutils literal"><span class="pre">BlogTest</span></tt> located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span></tt> with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span>

<span class="c1">// ..</span>

<span class="k">class</span> <span class="nc">BlogTest</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testSlugify</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;hello-world&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a very simple test case. It instantiates a new <tt class="docutils literal"><span class="pre">Blog</span></tt> entity and runs
an <tt class="docutils literal"><span class="pre">assertEquals()</span></tt> on the result of the <tt class="docutils literal"><span class="pre">slugify</span></tt> method. The <tt class="docutils literal"><span class="pre">assertEquals()</span></tt>
method takes 2 mandatory arguments, the expected result and the actual result.
An optional 3rd argument can be passed in to specify a message to display
when the test case fails.</p>
<p>Lets run our new unit test. Run the following on the command line.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app
</pre></div>
</div>
<p>You should see the following output.</p>
<div class="highlight-bash"><div class="highlight"><pre>PHPUnit 3.5.11 by Sebastian Bergmann.

.

Time: 1 second, Memory: 4.25Mb

OK <span class="o">(</span>1 <span class="nb">test</span>, 1 assertion<span class="o">)</span>
</pre></div>
</div>
<p>The output from PHPUnit is very simple, Its start by displaying some information about
PHPUnit and the outputs a number of <tt class="docutils literal"><span class="pre">.</span></tt> for each test it runs, in our case
we are only running 1 test so only 1 <tt class="docutils literal"><span class="pre">.</span></tt> is output. The last statement informs
us of the result of the tests. For our <tt class="docutils literal"><span class="pre">BlogTest</span></tt> we only ran 1 test with 1
assertion. If you have color output on your command line you will also see the
last line displayed in green showing everything executed OK.
Lets update the <tt class="docutils literal"><span class="pre">testSlugify()</span></tt> method to see what happens when the tests fails.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span>

<span class="c1">// ..</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testSlugify</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;hello-world&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;a day with symfony2&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;A Day With Symfony2&#39;</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Re run the unit tests as before. The following output will be displayed</p>
<div class="highlight-bash"><div class="highlight"><pre>PHPUnit 3.5.11 by Sebastian Bergmann.

F

Time: 0 seconds, Memory: 4.25Mb

There was 1 failure:

1<span class="o">)</span> Blogger<span class="se">\B</span>logBundle<span class="se">\T</span>ests<span class="se">\E</span>ntity<span class="se">\B</span>logTest::testSlugify
Failed asserting that two strings are equal.
--- Expected
+++ Actual
@@ @@
-a day with symfony2
+a-day-with-symfony2

/var/www/html/symblog/symblog/src/Blogger/BlogBundle/Tests/Entity/BlogTest.php:15

FAILURES!
Tests: 1, Assertions: 2, Failures: 1.
</pre></div>
</div>
<p>The output is a bit more involved this time. We can see the <tt class="docutils literal"><span class="pre">.</span></tt> for the run tests
is replaced by a <tt class="docutils literal"><span class="pre">F</span></tt>. This tells us the test failed. You will also see the <tt class="docutils literal"><span class="pre">E</span></tt>
character output if your test contains Errors. Next PHPUnit notifies us in
detail of the failures, in this case, the 1 failure. We can see the
<tt class="docutils literal"><span class="pre">Blogger\BlogBundle\Tests\Entity\BlogTest::testSlugify</span></tt> method failed because
the Expected and the Actual values were different. If you have color output on
your command line you will also see the last line displayed in red showing
there were failures in your tests. Correct the <tt class="docutils literal"><span class="pre">testSlugify()</span></tt> method so
the tests execute successfully.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span>

<span class="c1">// ..</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testSlugify</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;hello-world&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;a-day-with-symfony2&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;A Day With Symfony2&#39;</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Before moving on add some more test for <tt class="docutils literal"><span class="pre">slugify()</span></tt> method.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span>

<span class="c1">// ..</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testSlugify</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;hello-world&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;a-day-with-symfony2&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;A Day With Symfony2&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;hello-world&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;Hello    world&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;symblog&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39;symblog &#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;symblog&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">slugify</span><span class="p">(</span><span class="s1">&#39; symblog&#39;</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we have tested the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity slugify method, we need to  ensure the <tt class="docutils literal"><span class="pre">Blog</span></tt>
<tt class="docutils literal"><span class="pre">$slug</span></tt> member is correctly set when the <tt class="docutils literal"><span class="pre">$title</span></tt> member of the <tt class="docutils literal"><span class="pre">Blog</span></tt> is
updated. Add the following methods to the <tt class="docutils literal"><span class="pre">BlogTest</span></tt> file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Entity/BlogTest.php</span>

<span class="c1">// ..</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testSetSlug</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">();</span>

    <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">setSlug</span><span class="p">(</span><span class="s1">&#39;Symfony2 Blog&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;symfony2-blog&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">getSlug</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testSetTitle</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blog</span><span class="p">();</span>

    <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">setTitle</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;hello-world&#39;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">getSlug</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We begin by testing the <tt class="docutils literal"><span class="pre">setSlug</span></tt> method to ensure the <tt class="docutils literal"><span class="pre">$slug</span></tt> member is
correctly slugified when updated. Next we check the <tt class="docutils literal"><span class="pre">$slug</span></tt> member is correctly
updated when the <tt class="docutils literal"><span class="pre">setTitle</span></tt> method is called on the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity.</p>
<p>Run the tests to verify the <tt class="docutils literal"><span class="pre">Blog</span></tt> entity is functioning correctly.</p>
</div>
<div class="section" id="testing-the-twig-extension">
<h3>Testing the Twig extension<a class="headerlink" href="#testing-the-twig-extension" title="Permalink to this headline">¶</a></h3>
<p>In the previous chapter we created a Twig extension to convert a <tt class="docutils literal"><span class="pre">\DateTime</span></tt>
instance into a string detailing the duration since a time period. Create a new test file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Twig/Extensions/BloggerBlogExtensionTest.php</span></tt> and
update with the following content.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Tests/Twig/Extensions/BloggerBlogExtensionTest.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Tests\Twig\Extensions</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Twig\Extensions\BloggerBlogExtension</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BloggerBlogExtensionTest</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testCreatedAgo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$blog</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BloggerBlogExtension</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;0 seconds ago&quot;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">()));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;34 seconds ago&quot;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDateTime</span><span class="p">(</span><span class="o">-</span><span class="mi">34</span><span class="p">)));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;1 minute ago&quot;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDateTime</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">)));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;2 minutes ago&quot;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDateTime</span><span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">)));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;1 hour ago&quot;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDateTime</span><span class="p">(</span><span class="o">-</span><span class="mi">3600</span><span class="p">)));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;1 hour ago&quot;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDateTime</span><span class="p">(</span><span class="o">-</span><span class="mi">3601</span><span class="p">)));</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s2">&quot;2 hours ago&quot;</span><span class="p">,</span> <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDateTime</span><span class="p">(</span><span class="o">-</span><span class="mi">7200</span><span class="p">)));</span>

        <span class="c1">// Cannot create time in the future</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setExpectedException</span><span class="p">(</span><span class="s1">&#39;\InvalidArgumentException&#39;</span><span class="p">);</span>
        <span class="nv">$blog</span><span class="o">-&gt;</span><span class="na">createdAgo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDateTime</span><span class="p">(</span><span class="mi">60</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getDateTime</span><span class="p">(</span><span class="nv">$delta</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="nb">date</span><span class="p">(</span><span class="s2">&quot;Y-m-d H:i:s&quot;</span><span class="p">,</span> <span class="nb">time</span><span class="p">()</span><span class="o">+</span><span class="nv">$delta</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The class is setup much the same as before, creating a method <tt class="docutils literal"><span class="pre">testCreatedAgo()</span></tt>
to test the Twig Extension. We introduce another PHPUnit method in this test case,
the <tt class="docutils literal"><span class="pre">setExpectedException()</span></tt> method. This method should be called before executing
a method you expect to throw an exception. We know that the <tt class="docutils literal"><span class="pre">createdAgo</span></tt> method
of the Twig extension cannot handle dates in the future and will throw an
<tt class="docutils literal"><span class="pre">\Exception</span></tt>. The <tt class="docutils literal"><span class="pre">getDateTime()</span></tt> method is simply a helper method for
creating a <tt class="docutils literal"><span class="pre">\DateTime</span></tt> instance. Notice it is not prefixed with <tt class="docutils literal"><span class="pre">test</span></tt> so
PHPUnit will not try to execute it as a test case. Open up the command line
and run the tests for this file. We could simply run the test as before, but
we can also tell PHPUnit to run tests for a specific folder (and its sub folders)
or a file. Run the following command.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app src/Blogger/BlogBundle/Tests/Twig/Extensions/BloggerBlogExtensionTest.php
</pre></div>
</div>
<p>This will run the tests for the <tt class="docutils literal"><span class="pre">BloggerBlogExtensionTest</span></tt> file only. PHPUnit
will inform us that the tests failed. The output is shown below.</p>
<div class="highlight-bash"><div class="highlight"><pre>1<span class="o">)</span> Blogger<span class="se">\B</span>logBundle<span class="se">\T</span>ests<span class="se">\T</span>wig<span class="se">\E</span>xtension<span class="se">\B</span>loggerBlogExtensionTest::testCreatedAgo
Failed asserting that two strings are equal.
--- Expected
+++ Actual
@@ @@
-0 seconds ago
+0 second ago

/var/www/html/symblog/symblog/src/Blogger/BlogBundle/Tests/Twig/Extensions/BloggerBlogExtensionTest.php:14
</pre></div>
</div>
<p>We were expecting the first assertion to return <tt class="docutils literal"><span class="pre">0</span> <span class="pre">seconds</span> <span class="pre">ago</span></tt> but it didn&#8217;t, the
word second was not plural. Lets update the Twig Extension located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Twig/Extensions/BloggerBlogBundle.php</span></tt> to correct this.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Twig/Extensions/BloggerBlogBundle.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Twig\Extensions</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BloggerBlogExtension</span> <span class="k">extends</span> <span class="nx">\Twig_Extension</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createdAgo</span><span class="p">(</span><span class="nx">\DateTime</span> <span class="nv">$dateTime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Seconds</span>
            <span class="nv">$time</span> <span class="o">=</span> <span class="nv">$delta</span><span class="p">;</span>
            <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s2">&quot; second&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$time</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; ago&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// ..</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Re run the PHPUnit tests. You should see the first assertion passing correctly,
but our test case still fails. Lets examine the next output.</p>
<div class="highlight-bash"><div class="highlight"><pre>1<span class="o">)</span> Blogger<span class="se">\B</span>logBundle<span class="se">\T</span>ests<span class="se">\T</span>wig<span class="se">\E</span>xtension<span class="se">\B</span>loggerBlogExtensionTest::testCreatedAgo
Failed asserting that two strings are equal.
--- Expected
+++ Actual
@@ @@
-1 hour ago
+60 minutes ago

/var/www/html/symblog/symblog/src/Blogger/BlogBundle/Tests/Twig/Extensions/BloggerBlogExtensionTest.php:18
</pre></div>
</div>
<p>We can see now that the 5th assertion is failing (notice the 18 at the end of the
output, this gives us the line number in the file where the assertion failed).
Looking at the test case we can see that the Twig Extension has functioned
incorrectly. 1 hour ago should have been returned, but instead 60 minutes ago
was. If we examine the code in the <tt class="docutils literal"><span class="pre">BloggerBlogExtension</span></tt> Twig
extension we can see the reason. We compare the time to be inclusive, i.e., we use
<tt class="docutils literal"><span class="pre">&lt;=</span></tt> rather than <tt class="docutils literal"><span class="pre">&lt;</span></tt>. We can also see this is the case when checking for
hours. Update the Twig extension located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Twig/Extensions/BloggerBlogBundle.php</span></tt> to correct
this.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Twig/Extensions/BloggerBlogBundle.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Twig\Extensions</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BloggerBlogExtension</span> <span class="k">extends</span> <span class="nx">\Twig_Extension</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createdAgo</span><span class="p">(</span><span class="nx">\DateTime</span> <span class="nv">$dateTime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>

        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Mins</span>
            <span class="nv">$time</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="nv">$delta</span> <span class="o">/</span> <span class="mi">60</span><span class="p">);</span>
            <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s2">&quot; minute&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; ago&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nv">$delta</span> <span class="o">&lt;</span> <span class="mi">86400</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Hours</span>
            <span class="nv">$time</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="nv">$delta</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">);</span>
            <span class="nv">$duration</span> <span class="o">=</span> <span class="nv">$time</span> <span class="o">.</span> <span class="s2">&quot; hour&quot;</span> <span class="o">.</span> <span class="p">((</span><span class="nv">$time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;s&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; ago&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ..</span>
    <span class="p">}</span>

    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now re run all our tests using the following command.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app
</pre></div>
</div>
<p>This runs all our tests, and shows all tests pass successfully. Although we have
only written a small number of unit tests you should be getting a feel for how
powerful and important testing is when writing code. While the above errors
were minor, they were still errors. Testing also helps any future functionality
added to the project breaking previous features. This concludes the unit testing
for now. We will see more unit testing in the following chapters. Try adding some
of your own unit tests to test functionality that has been missed.</p>
</div>
</div>
<div class="section" id="id5">
<h2>Functional Testing<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Now we have written some unit tests, lets move on to testing multiple components
together. The first section of the functional testing will involve simulating
browser requests to tests the generated responses.</p>
<div class="section" id="testing-the-about-page">
<h3>Testing the About page<a class="headerlink" href="#testing-the-about-page" title="Permalink to this headline">¶</a></h3>
<p>We begin testing the <tt class="docutils literal"><span class="pre">PageController</span></tt> class for the about page. As the about page
is very simple, this is a good place to start. Create a new file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span></tt> and add
the following content.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Tests\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PageControllerTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testAbout</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">();</span>

        <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/about&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;h1:contains(&quot;About symblog&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We have already seen a Controller test very similar to this when we briefly looked
at the <tt class="docutils literal"><span class="pre">DefaultControllerTest</span></tt> class. This is testing the about page of symblog,
checking the string <tt class="docutils literal"><span class="pre">About</span> <span class="pre">symblog</span></tt> is present in the generated HTML,
specifically within the <tt class="docutils literal"><span class="pre">H1</span></tt> tag. The <tt class="docutils literal"><span class="pre">PageControllerTest</span></tt> class doesn&#8217;t extend the
<tt class="docutils literal"><span class="pre">\PHPUnit_Framework_TestCase</span></tt> as we saw with the unit testing examples,
it instead extends the class <tt class="docutils literal"><span class="pre">WebTestCase</span></tt>. This class is part of the Symfony2
FrameworkBundle.</p>
<p>As explained before PHPUnit test classes must extend the
<tt class="docutils literal"><span class="pre">\PHPUnit_Framework_TestCase</span></tt>, but when extra or common functionality is
required across multiple Test cases it is useful to encapsulate this in its
own class and have your Test classes extend this. The <tt class="docutils literal"><span class="pre">WebTestCase</span></tt> does
exactly this, it provides a number of useful method for running functional tests
in Symfony2. Have a look at the <tt class="docutils literal"><span class="pre">WebTestCase</span></tt> file located at
<tt class="docutils literal"><span class="pre">vendor/symfony/src/Symfony/Bundle/FrameworkBundle/Test/WebTestCase.php</span></tt>, you
will see that this class is in fact extending the <tt class="docutils literal"><span class="pre">\PHPUnit_Framework_TestCase</span></tt>
class.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// vendor/symfony/src/Symfony/Bundle/FrameworkBundle/Test/WebTestCase.php</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">WebTestCase</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="c1">// ..</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you look at the <tt class="docutils literal"><span class="pre">createClient()</span></tt> method in the <tt class="docutils literal"><span class="pre">WebTestCase</span></tt> class
you can see it creates an instance of the Symfony2 Kernel. Following the methods
through you will also notice that the <tt class="docutils literal"><span class="pre">environment</span></tt> is set to <tt class="docutils literal"><span class="pre">test</span></tt>
(unless overridden as one of the arguments to <tt class="docutils literal"><span class="pre">createClient()</span></tt>). This is the
<tt class="docutils literal"><span class="pre">test</span></tt> environment we spoke about in the previous chapter.</p>
<p>Looking back at our test class we can see the <tt class="docutils literal"><span class="pre">createClient()</span></tt> method is
called to get the test up and running. We then call the <tt class="docutils literal"><span class="pre">request()</span></tt> method on the
client to simulate a browser HTTP GET request to the url <tt class="docutils literal"><span class="pre">/about</span></tt> (this would
be just like you visiting <tt class="docutils literal"><span class="pre">http://symblog.dev/about</span></tt> in your browser). The
request gives us a <tt class="docutils literal"><span class="pre">Crawler</span></tt> object back, which contains the <tt class="docutils literal"><span class="pre">Response</span></tt>. The
<tt class="docutils literal"><span class="pre">Crawler</span></tt> class is very useful as it lets us traverse the returned HTML. We
use the <tt class="docutils literal"><span class="pre">Crawler</span></tt> instance to check that the <tt class="docutils literal"><span class="pre">H1</span></tt> tag in the response HTML
contains the words <tt class="docutils literal"><span class="pre">About</span> <span class="pre">symblog</span></tt>. You&#8217;ll notice that even though we are
extending the class <tt class="docutils literal"><span class="pre">WebTestCase</span></tt> we still use the assert method as before
(remember the <tt class="docutils literal"><span class="pre">PageControllerTest</span></tt> class is still is child of the
<tt class="docutils literal"><span class="pre">\PHPUnit_Framework_TestCase</span></tt> class).</p>
<p>Lets run the <tt class="docutils literal"><span class="pre">PageControllerTest</span></tt> using the following command. When writing
tests its useful to only execute the tests for the file you are currently working on.
As your test suite gets large, running tests can be a time consuming tasks.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app/ src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php
</pre></div>
</div>
<p>You should be greeted with the message <tt class="docutils literal"><span class="pre">OK</span> <span class="pre">(1</span> <span class="pre">test,</span> <span class="pre">1</span> <span class="pre">assertion)</span></tt> letting us
know that 1 test (the <tt class="docutils literal"><span class="pre">testAbout()</span></tt>) ran, with 1 assertion (the <tt class="docutils literal"><span class="pre">assertEquals()</span></tt>).</p>
<p>Try changing the <tt class="docutils literal"><span class="pre">About</span> <span class="pre">symblog</span></tt> string to <tt class="docutils literal"><span class="pre">Contact</span></tt> and then re run the test.
The test will now fail as <tt class="docutils literal"><span class="pre">Contact</span></tt> wont be found, causing <tt class="docutils literal"><span class="pre">asertEquals</span></tt> to
equate to false.</p>
<div class="highlight-bash"><div class="highlight"><pre>1<span class="o">)</span> Blogger<span class="se">\B</span>logBundle<span class="se">\T</span>ests<span class="se">\C</span>ontroller<span class="se">\P</span>ageControllerTest::testAbout
Failed asserting that 0 matches expected 1.
</pre></div>
</div>
<p>Revert the string back to <tt class="docutils literal"><span class="pre">About</span> <span class="pre">symblog</span></tt> before moving on.</p>
<p>The <tt class="docutils literal"><span class="pre">Crawler</span></tt> instance used allows you to traverse either HTML or XML
documents (which means the <tt class="docutils literal"><span class="pre">Crawler</span></tt> will only work with responses that return
HTML or XML). We can use the <tt class="docutils literal"><span class="pre">Crawler</span></tt> to traverse the generated response using
methods such as <tt class="docutils literal"><span class="pre">filter()</span></tt>, <tt class="docutils literal"><span class="pre">first()</span></tt>, <tt class="docutils literal"><span class="pre">last()</span></tt>, and <tt class="docutils literal"><span class="pre">parents()</span></tt>. If you
have used <a class="reference external" href="http://jquery.com/">jQuery</a> before you should feel right at home
with the <tt class="docutils literal"><span class="pre">Crawler</span></tt> class. A full list of supported <tt class="docutils literal"><span class="pre">Crawler</span></tt> traversal methods can be
found in the <a class="reference external" href="http://symfony.com/doc/current/book/testing.html#traversing">Testing</a> chapter of the
Symfony2 book. We will explore more of the <tt class="docutils literal"><span class="pre">Crawler</span></tt> features as we continue.</p>
</div>
<div class="section" id="homepage">
<h3>Homepage<a class="headerlink" href="#homepage" title="Permalink to this headline">¶</a></h3>
<p>While the test for the about page was simple, it has outlined the basic principles
of functional testing the website pages.</p>
<blockquote>
<div><ol class="arabic simple">
<li>Create the client</li>
<li>Request a page</li>
<li>Check the response</li>
</ol>
</div></blockquote>
<p>This is a simple overview of the process, in fact there are a number of other
steps we could also do such as clicking links and populating and submitting
forms.</p>
<p>Lets create a method to test the homepage. We know the homepage is available
via the URL <tt class="docutils literal"><span class="pre">/</span></tt> and that is should display the latest blog posts. Add a new
method <tt class="docutils literal"><span class="pre">testIndex()</span></tt> to the <tt class="docutils literal"><span class="pre">PageControllerTest</span></tt> class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span></tt> as shown below.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testIndex</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">();</span>

    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>

    <span class="c1">// Check there are some blog entries on the page</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;article.blog&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can see the same steps are taken as with the tests for the about page.
Run the test to ensure everything is working as expected.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app/ src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php
</pre></div>
</div>
<p>Lets now take the testing a bit further. Part of functional testing involves being
able to replicate what a user would do on the site. In order for users to move
between pages on your website they click links. Lets simulate this action now
to test the links to the show blog page work correctly when the blog title is clicked.
Update the <tt class="docutils literal"><span class="pre">testIndex()</span></tt> method in the <tt class="docutils literal"><span class="pre">PageControllerTest</span></tt> class with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testIndex</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="c1">// Find the first link, get the title, ensure this is loaded on the next page</span>
    <span class="nv">$blogLink</span>   <span class="o">=</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;article.blog h2 a&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
    <span class="nv">$blogTitle</span>  <span class="o">=</span> <span class="nv">$blogLink</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">();</span>
    <span class="nv">$crawler</span>    <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">click</span><span class="p">(</span><span class="nv">$blogLink</span><span class="o">-&gt;</span><span class="na">link</span><span class="p">());</span>

    <span class="c1">// Check the h2 has the blog title in it</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;h2:contains(&quot;&#39;</span> <span class="o">.</span> <span class="nv">$blogTitle</span> <span class="o">.</span><span class="s1">&#39;&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first thing we do it use the <tt class="docutils literal"><span class="pre">Crawler</span></tt> to extract the text within the first
blog title link. This is done using the filter <tt class="docutils literal"><span class="pre">article.blog</span> <span class="pre">h2</span> <span class="pre">a</span></tt>. This filter
is used return the <tt class="docutils literal"><span class="pre">a</span></tt> tag within the <tt class="docutils literal"><span class="pre">H2</span></tt> tag of the <tt class="docutils literal"><span class="pre">article.blog</span></tt>
article. To understand this better, have a look at the markup used on the homepage
for displaying blogs.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;blog&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;2011-09-05T21:06:19+01:00&quot;</span><span class="nt">&gt;</span>Monday, September 5, 2011<span class="nt">&lt;/time&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/app_dev.php/1/a-day-with-symfony2&quot;</span><span class="nt">&gt;</span>A day with Symfony2<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
    <span class="nt">&lt;/header&gt;</span>

    <span class="c">&lt;!-- .. --&gt;</span>
<span class="nt">&lt;/article&gt;</span>
<span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;blog&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;&lt;time</span> <span class="na">datetime=</span><span class="s">&quot;2011-09-05T21:06:19+01:00&quot;</span><span class="nt">&gt;</span>Monday, September 5, 2011<span class="nt">&lt;/time&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;header&gt;</span>
        <span class="nt">&lt;h2&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/app_dev.php/2/the-pool-on-the-roof-must-have-a-leak&quot;</span><span class="nt">&gt;</span>The pool on the roof must have a leak<span class="nt">&lt;/a&gt;&lt;/h2&gt;</span>
    <span class="nt">&lt;/header&gt;</span>

    <span class="c">&lt;!-- .. --&gt;</span>
<span class="nt">&lt;/article&gt;</span>
</pre></div>
</div>
<p>You can see the filter <tt class="docutils literal"><span class="pre">article.blog</span> <span class="pre">h2</span> <span class="pre">a</span></tt> structure in place in the homepage
markup. You&#8217;ll also notice that there is more than one <tt class="docutils literal"><span class="pre">&lt;article</span> <span class="pre">class=&quot;blog&quot;&gt;</span></tt> in
the markup, meaning the <tt class="docutils literal"><span class="pre">Crawler</span></tt> filter will return a collection. As we only want
the first link, we use the <tt class="docutils literal"><span class="pre">first()</span></tt> method on the collection. Finally we use
the <tt class="docutils literal"><span class="pre">text()</span></tt> method to extract the link text, in this case it will be the text
<tt class="docutils literal"><span class="pre">A</span> <span class="pre">day</span> <span class="pre">with</span> <span class="pre">Symfony2</span></tt>. Next, the blog title link is clicked to navigate to the
blog show page. The client <tt class="docutils literal"><span class="pre">click()</span></tt> method takes a link object and returns the
<tt class="docutils literal"><span class="pre">Response</span></tt> in a <tt class="docutils literal"><span class="pre">Crawler</span></tt> instance. You should by now be noticing that the
<tt class="docutils literal"><span class="pre">Crawler</span></tt> object is a key part to functional testing.</p>
<p>The <tt class="docutils literal"><span class="pre">Crawler</span></tt> object now contains the Response for the blog show page. We need
to test that the link we navigated took us to the right page. We can use the
<tt class="docutils literal"><span class="pre">$blogTitle</span></tt> value we retrieved earlier to check this against the title in the
Response.</p>
<p>Run the tests to ensure that navigation between the homepage and the blog show
pages is working correctly.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app/ src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php
</pre></div>
</div>
<p>Now you have an understanding of how to navigate through the website pages
when functional testing, lets move onto testing forms.</p>
</div>
<div class="section" id="testing-the-contact-page">
<h3>Testing the Contact Page<a class="headerlink" href="#testing-the-contact-page" title="Permalink to this headline">¶</a></h3>
<p>Users of symblog are able to submit contact enquiries by completing the form on
the contact page <tt class="docutils literal"><span class="pre">http://symblog.dev/contact</span></tt>. Lets test that submissions
of this form work correctly. First we need to outline what should happen when
the form is successfully submitted (successfully submitted in this case means
there are no errors present in the form).</p>
<blockquote>
<div><ol class="arabic simple">
<li>Navigate to contact page</li>
<li>Populate contact form with values</li>
<li>Submit form</li>
<li>Check email was sent to symblog</li>
<li>Check response to client contains notification of successful contact</li>
</ol>
</div></blockquote>
<p>So far we have explored enough to be able to complete steps 1 and 5 only. We will
now look at how to test the 3 middle steps.</p>
<p>Add a new method <tt class="docutils literal"><span class="pre">testContact()</span></tt> to the <tt class="docutils literal"><span class="pre">PageControllerTest</span></tt> class located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span></tt>.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testContact</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">();</span>

    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/contact&#39;</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;h1:contains(&quot;Contact symblog&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">());</span>

    <span class="c1">// Select based on button value, or id or name for buttons</span>
    <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">selectButton</span><span class="p">(</span><span class="s1">&#39;Submit&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">form</span><span class="p">();</span>

    <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;blogger_blogbundle_enquirytype[name]&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="s1">&#39;name&#39;</span><span class="p">;</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;blogger_blogbundle_enquirytype[email]&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="s1">&#39;email@email.com&#39;</span><span class="p">;</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;blogger_blogbundle_enquirytype[subject]&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="s1">&#39;Subject&#39;</span><span class="p">;</span>
    <span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;blogger_blogbundle_enquirytype[body]&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="s1">&#39;The comment body must be at least 50 characters long as there is a validation constrain on the Enquiry entity&#39;</span><span class="p">;</span>

    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">submit</span><span class="p">(</span><span class="nv">$form</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;.blogger-notice:contains(&quot;Your contact enquiry was successfully sent. Thank you!&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We begin in the usual fashion, making a request to the <tt class="docutils literal"><span class="pre">/contact</span></tt> URL, and
checking the page contains the correct <tt class="docutils literal"><span class="pre">H1</span></tt> title. Next we use the <tt class="docutils literal"><span class="pre">Crawler</span></tt>
to select the form submit button. The reason we select the button and not the
form is that a form may contain multiple buttons that we may want to click
independently. From the selected button we are able to retrieve the form. We are
able to set the form values using the array subscript notation <tt class="docutils literal"><span class="pre">[]</span></tt>.
Finally the form is passed to the client <tt class="docutils literal"><span class="pre">submit()</span></tt> method to actually
submit the form. As usual, we receive a <tt class="docutils literal"><span class="pre">Crawler</span></tt> instance back. Using the
<tt class="docutils literal"><span class="pre">Crawler</span></tt> response we check to ensure the flash message is present in the returned
response. Run the test to check everything is functioning correctly.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app/ src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php
</pre></div>
</div>
<p>The tests failed. We are given the following output from PHPUnit.</p>
<div class="highlight-bash"><div class="highlight"><pre>1<span class="o">)</span> Blogger<span class="se">\B</span>logBundle<span class="se">\T</span>ests<span class="se">\C</span>ontroller<span class="se">\P</span>ageControllerTest::testContact
Failed asserting that &lt;integer:0&gt; matches expected &lt;integer:1&gt;.

/var/www/html/symblog/symblog/src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php:53

FAILURES!
Tests: 3, Assertions: 5, Failures: 1.
</pre></div>
</div>
<p>The output is informing us that the flash message could not be found in the
response from the form submit. This is because when in the <tt class="docutils literal"><span class="pre">test</span></tt> environment,
redirects are not followed. When the form is successfully validated in the
<tt class="docutils literal"><span class="pre">PageController</span></tt> class a redirect happens. This redirect is not being
followed; We need to explicitly say that the redirect should be followed. The
reason redirects are not followed is simple, you may want to check the current
response first. We will demonstrate this soon to check the email was sent.
Update the <tt class="docutils literal"><span class="pre">PageControllerTest</span></tt> class to set the client to follow the
redirect.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testContact</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">submit</span><span class="p">(</span><span class="nv">$form</span><span class="p">);</span>

    <span class="c1">// Need to follow redirect</span>
    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">followRedirect</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;.blogger-notice:contains(&quot;Your contact enquiry was successfully sent. Thank you!&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>No when you run the PHPUnit tests they should pass. Lets now look at the final
step of checking the contact form submission process, step 4, checking an email
was sent to symblog. We already know that emails will not be delivered in the
<tt class="docutils literal"><span class="pre">test</span></tt> environment due to the following configuration.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config_test.yml</span>

<span class="l-Scalar-Plain">swiftmailer</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">disable_delivery</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>We can test the emails were sent using the information gathered by the web profiler.
This is where the importance of the client not following redirects comes in. The
check on the profiler needs to be done before the redirect happens, as the information
in the profiler will be lost. Update the <tt class="docutils literal"><span class="pre">testContact()</span></tt> method with the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="c1">// src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">testContact</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ..</span>

    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">submit</span><span class="p">(</span><span class="nv">$form</span><span class="p">);</span>

    <span class="c1">// Check email has been sent</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$profile</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">getProfile</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="nv">$swiftMailerProfiler</span> <span class="o">=</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getCollector</span><span class="p">(</span><span class="s1">&#39;swiftmailer&#39;</span><span class="p">);</span>

        <span class="c1">// Only 1 message should have been sent</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$swiftMailerProfiler</span><span class="o">-&gt;</span><span class="na">getMessageCount</span><span class="p">());</span>

        <span class="c1">// Get the first message</span>
        <span class="nv">$messages</span> <span class="o">=</span> <span class="nv">$swiftMailerProfiler</span><span class="o">-&gt;</span><span class="na">getMessages</span><span class="p">();</span>
        <span class="nv">$message</span>  <span class="o">=</span> <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$messages</span><span class="p">);</span>

        <span class="nv">$symblogEmail</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getParameter</span><span class="p">(</span><span class="s1">&#39;blogger_blog.emails.contact_email&#39;</span><span class="p">);</span>
        <span class="c1">// Check message is being sent to correct address</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertArrayHasKey</span><span class="p">(</span><span class="nv">$symblogEmail</span><span class="p">,</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">getTo</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="c1">// Need to follow redirect</span>
    <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">followRedirect</span><span class="p">();</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;.blogger-notice:contains(&quot;Your contact enquiry was successfully sent. Thank you!&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After the form submit we check to see if the profiler is available as it may have
been disabled by a configuration setting for the current environment.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Remember tests don&#8217;t have to be run in the <tt class="docutils literal"><span class="pre">test</span></tt> environment, they could be
run on the <tt class="docutils literal"><span class="pre">production</span></tt> environment where things like the profiler wont be
available.</p>
</div>
<p>If we are able to get the profiler we make a request to retrieve the
<tt class="docutils literal"><span class="pre">swiftmailer</span></tt> collector. The <tt class="docutils literal"><span class="pre">swiftmailer</span></tt> collector works behind the scenes
to gather information about how the emailing service is used. We can use this to
get information regarding which emails have been sent.</p>
<p>Next we use the <tt class="docutils literal"><span class="pre">getMessageCount()</span></tt> method to check that 1 email was sent. This
maybe enough to ensure that at least an email is going to be sent, but it doesn&#8217;t verify
that the email will be sent to the correct location. It could be very embarrassing
or even damaging for emails to be sent to the wrong email address. To check this
isn&#8217;t the case we verify the email to address is correct.</p>
<p>Now re run the tests to check everything is working correctly.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app/ src/Blogger/BlogBundle/Tests/Controller/PageControllerTest.php
</pre></div>
</div>
</div>
<div class="section" id="testing-adding-blog-comments">
<h3>Testing Adding Blog Comments<a class="headerlink" href="#testing-adding-blog-comments" title="Permalink to this headline">¶</a></h3>
<p>Lets now use the knowledge we have gained from the previous tests on the contact page
to test the process of submitting a blog comment.
Again we outline what should happen when the form is successfully
submitted.</p>
<blockquote>
<div><ol class="arabic simple">
<li>Navigate to a blog page</li>
<li>Populate comment form with values</li>
<li>Submit form</li>
<li>Check new comment is added to end of blog comment list</li>
<li>Also check sidebar latest comments to ensure comment is at top of list</li>
</ol>
</div></blockquote>
<p>Create a new file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Controller/BlogControllerTest.php</span></tt>
and add in the following.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Tests/Controller/BlogControllerTest.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Tests\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BlogControllerTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testAddBlogComment</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$client</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createClient</span><span class="p">();</span>

        <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/1/a-day-with-symfony&#39;</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;h2:contains(&quot;A day with Symfony2&quot;)&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">());</span>

        <span class="c1">// Select based on button value, or id or name for buttons</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">selectButton</span><span class="p">(</span><span class="s1">&#39;Submit&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">form</span><span class="p">();</span>

        <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">submit</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;blogger_blogbundle_commenttype[user]&#39;</span>          <span class="o">=&gt;</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;blogger_blogbundle_commenttype[comment]&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;comment&#39;</span><span class="p">,</span>
        <span class="p">));</span>

        <span class="c1">// Need to follow redirect</span>
        <span class="nv">$crawler</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">followRedirect</span><span class="p">();</span>

        <span class="c1">// Check comment is now displaying on page, as the last entry. This ensure comments</span>
        <span class="c1">// are posted in order of oldest to newest</span>
        <span class="nv">$articleCrawler</span> <span class="o">=</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;section .previous-comments article&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nv">$articleCrawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;header span.highlight&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="nv">$articleCrawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">());</span>

        <span class="c1">// Check the sidebar to ensure latest comments are display and there is 10 of them</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;aside.sidebar section&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()</span>
                                        <span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nv">$crawler</span><span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;aside.sidebar section&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">last</span><span class="p">()</span>
                                            <span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">()</span>
                                            <span class="o">-&gt;</span><span class="na">filter</span><span class="p">(</span><span class="s1">&#39;header span.highlight&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">()</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We jump straight in this time with the entire test. Before we begin dissecting the code,
run the tests for this file to ensure everything is working correctly.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app/ src/Blogger/BlogBundle/Tests/Controller/BlogControllerTest.php
</pre></div>
</div>
<p>PHPUnit should inform you that the 1 test was executed successfully. Looking at
the code for the <tt class="docutils literal"><span class="pre">testAddBlogComment()</span></tt> we can see things begin in the usual
format, creating a client, requesting a page and checking the page we are on is
correct. We then proceed to get the add comment form, and submit the form. The
way we populate the form values is slightly different than the previous version.
This time we use the 2nd argument of the client <tt class="docutils literal"><span class="pre">submit()</span></tt> method to pass in
the values for the form.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>We could also use the Object Oriented interface to set the values of the form fields.
Some examples are shown below.</p>
<div class="last highlight-php"><div class="highlight"><pre><span class="c1">// Tick a checkbox</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;show_emal&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">tick</span><span class="p">();</span>

<span class="c1">// Select an option or a radio</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;Male&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>After submitting the form, we request the client should follow the redirect so we
can check the response. We use the <tt class="docutils literal"><span class="pre">Crawler</span></tt> again to get the last blog comment, which
should be the one we just submitted. Finally we check the latest comments in the
sidebar to check the comment is also the first one in the list.</p>
</div>
<div class="section" id="blog-repository">
<h3>Blog Repository<a class="headerlink" href="#blog-repository" title="Permalink to this headline">¶</a></h3>
<p>The last part of the functional testing we will explore in this chapter is
testing a Doctrine 2 repository. Create a new file located at
<tt class="docutils literal"><span class="pre">src/Blogger/BlogBundle/Tests/Repository/BlogRepositoryTest.php</span></tt> and add the
following content.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Blogger/BlogBundle/Tests/Repository/BlogRepositoryTest.php</span>

<span class="k">namespace</span> <span class="nx">Blogger\BlogBundle\Tests\Repository</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Blogger\BlogBundle\Repository\BlogRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Test\WebTestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">BlogRepositoryTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var \Blogger\BlogBundle\Repository\BlogRepository</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$blogRepository</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$kernel</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="na">createKernel</span><span class="p">();</span>
        <span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">boot</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blogRepository</span> <span class="o">=</span> <span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span>
                                       <span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;doctrine.orm.entity_manager&#39;</span><span class="p">)</span>
                                       <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;BloggerBlogBundle:Blog&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetTags</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$tags</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blogRepository</span><span class="o">-&gt;</span><span class="na">getTags</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertContains</span><span class="p">(</span><span class="s1">&#39;symblog&#39;</span><span class="p">,</span> <span class="nv">$tags</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testGetTagWeights</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$tagsWeight</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blogRepository</span><span class="o">-&gt;</span><span class="na">getTagWeights</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;php&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;symblog&#39;</span><span class="p">,</span> <span class="s1">&#39;blog&#39;</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$tagsWeight</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Test case where count is over max weight of 5</span>
        <span class="nv">$tagsWeight</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blogRepository</span><span class="o">-&gt;</span><span class="na">getTagWeights</span><span class="p">(</span>
            <span class="nb">array_fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$tagsWeight</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>

        <span class="c1">// Test case with multiple counts over max weight of 5</span>
        <span class="nv">$tagsWeight</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blogRepository</span><span class="o">-&gt;</span><span class="na">getTagWeights</span><span class="p">(</span>
            <span class="nb">array_merge</span><span class="p">(</span><span class="nb">array_fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="p">),</span> <span class="nb">array_fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">),</span> <span class="nb">array_fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">))</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nv">$tagsWeight</span><span class="p">[</span><span class="s1">&#39;php&#39;</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nv">$tagsWeight</span><span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$tagsWeight</span><span class="p">[</span><span class="s1">&#39;html&#39;</span><span class="p">]);</span>

        <span class="c1">// Test empty case</span>
        <span class="nv">$tagsWeight</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">blogRepository</span><span class="o">-&gt;</span><span class="na">getTagWeights</span><span class="p">(</span><span class="k">array</span><span class="p">());</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEmpty</span><span class="p">(</span><span class="nv">$tagsWeight</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As we want to perform tests that require a valid connection to the database
we extend the <tt class="docutils literal"><span class="pre">WebTestCase</span></tt> again as this allows us to bootstrap the Symfony2
Kernel. Run this test for this file using the following command.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit -c app/ src/Blogger/BlogBundle/Tests/Repository/BlogRepositoryTest.php
</pre></div>
</div>
</div>
</div>
<div class="section" id="code-coverage">
<h2>Code Coverage<a class="headerlink" href="#code-coverage" title="Permalink to this headline">¶</a></h2>
<p>Before we move on lets quickly touch on code coverage. Code coverage gives us an
insight into which parts of the code are executed when the tests are run. Using
this we can see the parts of our code that have no tests run on them, and
determine if we need to write test for them.</p>
<p>To output the code coverage analysis for your application run the following</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit --coverage-html ./phpunit-report -c app/
</pre></div>
</div>
<p>This will output the code coverage analysis to the folder <tt class="docutils literal"><span class="pre">phpunit-report</span></tt>.
Open the <tt class="docutils literal"><span class="pre">index.html</span></tt> file in your browser to see the analysis output.</p>
<p>See the <a class="reference external" href="http://www.phpunit.de/manual/current/en/code-coverage-analysis.html">Code Coverage Analysis</a>
chapter in the PHPUnit documentation for more information.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>We have covered a number of key areas with regards to testing. We have explored
both unit and functional testing to ensure our website is functioning correctly.
We have seen how to simulate browser requests and how to use the Symfony2 <tt class="docutils literal"><span class="pre">Crawler</span></tt>
class to check the Response from these requests.</p>
<p>Next we will look at the Symfony2 security component, and more specifically how to use it
for user management. We will also integrate the FOSUserBundle ready for us to work on the
symblog admin section.</p>
</div>
</div>



    <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="customising-the-view-more-with-twig.html">[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

    </div>

    <div id="disqus_thread"></div>

    <script type="text/javascript">
        var disqus_shortname = 'symblogtutorial';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
  <div class="bottomnav">
  
        <p>
        «&#160;&#160;<a href="customising-the-view-more-with-twig.html">[Part 5] - Customising the view: Twig extensions, The sidebar and Assetic</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

  </div>

    <div class="footer">
        &copy; Copyright 2011, dsyph3r.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>